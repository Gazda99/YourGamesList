@using YourGamesList.Contracts.Dto
@using YourGamesList.Contracts.Requests.Lists
@using YourGamesList.Web.Page.Services
@using YourGamesList.Web.Page.Services.UserLoginStateManager
@using YourGamesList.Web.Page.Services.Ygl
<style>
    .gameslistentry-tile-card {
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    }

    .gameslistentry-tile-card:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

</style>



<MudCard Outlined="true" Style="position: relative;" Class="gameslistentry-tile-card">
    <MudStack Row="true">
        <MudImage Src="@ImageUrl()" Width="176" Height="235"></MudImage>
        <MudStack Style="width: 100%;">
            <MudStack>
                <MudText>@Game.Name</MudText>
                <MudText>@FormatReleaseDate()</MudText>
                <MudText>@TruncateText(Game.Summary, 150)</MudText>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4">
                    <MudRating SelectedValue="@Rating()" SelectedValueChanged="@OnSelectedRatingChange"/>
                    <MudCheckBox T="bool"
                                 Value="@IsStarred()"
                                 Color="Color.Secondary"
                                 CheckedIcon="@Icons.Material.Filled.Favorite"
                                 UncheckedIcon="@Icons.Material.Filled.FavoriteBorder"
                                 ValueChanged="@OnIsStarredChange"/>
                </MudStack>
            </MudStack>
        </MudStack>
    </MudStack>
</MudCard>


@code {
    private const string GameReleaseDateFormat = "yyyy MMMM dd";

    [Inject] private ISnackbar Snackbar { get; set; } = default!;
    [Inject] private IUserLoginStateManager UserLoginStateManager { get; set; } = default!;
    [Inject] private IYglListsClient ListsClient { get; set; } = default!;
    [Inject] private IUserListsManager IUserListsManager { get; set; } = default!;


    [Parameter] public required GameListEntryDto GameListEntry { get; set; }
    [Parameter] public required Guid ListId { get; set; }
    private GameDto Game => GameListEntry.Game!;

    private string ImageUrl()
    {
        return !string.IsNullOrWhiteSpace(Game.ImageId) ? $"https://images.igdb.com/igdb/image/upload/t_cover_big/{Game.ImageId}.jpg" : "";
    }

    private string FormatReleaseDate()
    {
        return Game.FirstReleaseDate != 0 ? DateTimeOffset.FromUnixTimeSeconds(Game.FirstReleaseDate).ToString(GameReleaseDateFormat) : string.Empty;
    }

    private byte? _rating = null;

    private byte Rating()
    {
        if (_rating == null)
        {
            _rating = GameListEntry.Rating ?? 0;
        }

        return _rating.Value;
    }

    private bool? _isStarred = null;

    private bool IsStarred()
    {
        if (_isStarred == null)
        {
            _isStarred = GameListEntry.IsStarred;
        }

        return _isStarred.Value;
    }


    private static string TruncateText(string text, int maxLength)
    {
        if (maxLength <= 10)
        {
            maxLength = 10;
        }

        return text.Length >= maxLength ? $"{text[0..(maxLength - 3)]}..." : text;
    }

    private async Task OnSelectedRatingChange(int selectedRating)
    {
        _rating = (byte) selectedRating;

        var userToken = await UserLoginStateManager.GetUserToken();
        if (string.IsNullOrWhiteSpace(userToken))
        {
            //TODO:
            _rating = GameListEntry.Rating ?? 0;
            return;
        }

        var entryToUpdate = new EntryToUpdateRequestPart()
        {
            EntryId = GameListEntry.Id,
            Rating = (byte) selectedRating
        };

        var res = await ListsClient.UpdateListEntries(userToken, ListId, [entryToUpdate]);
        if (res.IsFailure)
        {
            _rating = GameListEntry.Rating ?? 0;
        }
        else
        {
            // Fire and forget
            _ = IUserListsManager.Refresh();
        }
    }

    private async Task OnIsStarredChange(bool selectedIsStarred)
    {
        _isStarred = selectedIsStarred;

        var userToken = await UserLoginStateManager.GetUserToken();
        if (string.IsNullOrWhiteSpace(userToken))
        {
            //TODO:
            _isStarred = GameListEntry.IsStarred;
            return;
        }

        var entryToUpdate = new EntryToUpdateRequestPart()
        {
            EntryId = GameListEntry.Id,
            IsStarred = selectedIsStarred
        };

        var res = await ListsClient.UpdateListEntries(userToken, ListId, [entryToUpdate]);
        if (res.IsFailure)
        {
            _isStarred = GameListEntry.IsStarred;
        }
        else
        {
            // Fire and forget
            _ = IUserListsManager.Refresh();
        }
    }

}