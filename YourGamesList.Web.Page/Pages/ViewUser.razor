@page "/user"
@using Microsoft.Extensions.Logging
@using YourGamesList.Contracts.Dto
@using YourGamesList.Contracts.Requests.Users
@using YourGamesList.Web.Page.Services
@using YourGamesList.Web.Page.Services.UserLoginStateManager
@using YourGamesList.Web.Page.Services.Ygl


<PageTitle>User</PageTitle>

@if (!_isPageInitialized)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" Class="mx-auto"/>
}
else
{
    @if (!_isUserLoggedIn)
    {
        <LoginFirst></LoginFirst>
    }
    else
    {
        @if (_userData != null)
        {
            <MudGrid>

                <MudItem xs="12" sm="6">
                    <MudPaper Class="pa-4">
                        <MudText Typo="Typo.caption">Username</MudText>
                        <MudText Typo="Typo.body1">@_userData.Username</MudText>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudPaper Class="pa-4">
                        <MudText Typo="Typo.caption">Country</MudText>
                        <MudText Typo="Typo.body1">@DisplayCountry()</MudText>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudPaper Class="pa-4">
                        <MudText Typo="Typo.caption">Date of Birth</MudText>
                        <MudText Typo="Typo.body1">@DisplayDateOfBirth()</MudText>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12">
                    <MudPaper Class="pa-4">
                        <MudText Typo="Typo.caption">Description</MudText>
                        <MudText Typo="Typo.body1">@DisplayDescription()</MudText>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" Class="d-flex justify-end mt-4">
                    <MudIconButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Icon="@Icons.Material.Filled.Save"
                                   OnClick="@SaveUserChanges">
                    </MudIconButton>
                </MudItem>
            </MudGrid>
        }
        else
        {
            <MudText>User Data failed to load!</MudText>
        }
    }
}


@code {
    [Inject] private ILogger<ViewUser> Logger { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;
    [Inject] private IUserLoginStateManager UserLoginStateManager { get; set; } = default!;
    [Inject] private IUserManager UserManager { get; set; } = default!;
    [Inject] private IYglUsersClient YglUsersClient { get; set; } = default!;

    private UserDto? _userData { get; set; } = null;

    private bool _isUserLoggedIn = false;
    private bool _isPageInitialized = false;

    private string[] _countries = [];

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _isUserLoggedIn = await UserLoginStateManager.IsUserLoggedIn();

        if (_isUserLoggedIn)
        {
            _isPageInitialized = false;

            var user = await UserManager.ReadOrRefresh();
            if (user.IsFailure)
            {
                Snackbar.Add("Could not load user page. Please try to refresh page.", Severity.Warning);

                return;
            }


            _userData = user.Value;
        }

        _isPageInitialized = true;
    }

    private string DisplayDateOfBirth()
    {
        return _userData?.DateOfBirth?.ToString("MMMM dd, yyyy") ?? "Not provided";
    }

    private string DisplayCountry()
    {
        return string.IsNullOrWhiteSpace(_userData?.Country) ? "Not provided" : _userData.Country;
    }

    private string DisplayDescription()
    {
        return string.IsNullOrWhiteSpace(_userData?.Description) ? "Not provided" : _userData.Description;
    }

    private async Task SaveUserChanges()
    {
        var userToken = await UserLoginStateManager.GetUserToken();
        if (string.IsNullOrWhiteSpace(userToken))
        {
            //TODO: error handling
            return;
        }

        var requestBody = new UserUpdateRequestBody()
        {
        };

        var res = await YglUsersClient.UpdateUser(userToken, requestBody);

        if (res.IsSuccess)
        {
            Snackbar.Add("Successfully updated the user.", Severity.Error);
        }
        else
        {
            Snackbar.Add("Could not update the user.", Severity.Error);
        }
    }

    private async Task FetchCountries(string? token)
    {
        var res = await YglUsersClient.GetCountries(token!);
    }


}