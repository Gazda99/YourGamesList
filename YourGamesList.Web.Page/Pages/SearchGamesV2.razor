@page "/searchGamesV2"
@using Microsoft.Extensions.Logging
@using YourGamesList.Contracts.Dto
@using YourGamesList.Contracts.Responses.Games
@using YourGamesList.Web.Page.Services.UserLoginState
@using YourGamesList.Web.Page.Services.Ygl

@if (_isLoading || !_searchResults.Any())
{
    <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" Class="mx-auto"/>
}
else if (!_isLoading && !_searchResults.Any())
{
}
else
{
    <MudGrid Justify="Justify.FlexStart" Spacing="3">
        <MudItem xs="12" sm="12" md="12" lg="12" xl="12" xxl="12">
            <SearchGamesInputPanel
                Themes="@_queryArguments.Themes"
                GameTypes="@_queryArguments.GameTypes"
                Genres="@_queryArguments.Genres"
            ></SearchGamesInputPanel>
        </MudItem>
        @foreach (var game in _searchResults)
        {
            <MudItem xs="12" sm="12" md="12" lg="6" xl="6" xxl="4">
                <GameTile Game="@game"></GameTile>
            </MudItem>
        }
    </MudGrid>
}


@code {
    [Inject] private ILogger<SearchGamesV2> Logger { get; set; } = default!;
    [Inject] private IYglGamesClient GamesClient { get; set; } = default!;
    [Inject] private IUserLoginStateManager UserLoginStateManager { get; set; } = default!;

    private bool _isLoading = false;
    private List<GameDto> _searchResults = [];
    private AvailableSearchQueryArgumentsResponse _queryArguments = default!;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        _isLoading = true;
        var token = await UserLoginStateManager.GetUserToken();
        await FetchQueryArguments(token);
        await LoadGameData(token);
        _isLoading = false;

    }

    private async Task FetchQueryArguments(string? token)
    {
        var res = await GamesClient.GetAvailableSearchParams(token!);
        _queryArguments = res.Value!;
    }

    private async Task LoadGameData(string? token)
    {
        var res = await GamesClient.SearchGames(token!, "witcher");
        _searchResults = res.Value!;
    }

}