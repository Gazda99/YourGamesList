@page "/searchGames"
@using Microsoft.Extensions.Logging
@using YourGamesList.Contracts.Dto
@using YourGamesList.Web.Page.Services.UserLoginState
@using YourGamesList.Web.Page.Services.Ygl
@using YourGamesList.Web.Page.Services.Ygl.Model
@using YourGamesList.Web.Page.Services.Ygl.Model.Responses


@if (!_isUserLoggedIn)
{
    <LoginFirst></LoginFirst>
}
else
{
    <MudPaper Class="pa-4 mb-4">
        <MudGrid Spacing="2">
            <MudItem xs="12" sm="6" md="4">
                <MudTextField @bind-Value="@_searchParams.SearchText"
                              Label="Search by name..."
                              Variant="Variant.Outlined"
                              Clearable="true"/>
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudSelect T="string" @bind-Value="@_searchParams.SelectedTheme"
                           Label="Theme"
                           Variant="Variant.Outlined"
                           Clearable="true">
                    @foreach (var theme in _themes)
                    {
                        <MudSelectItem Value="@theme">@theme</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudSelect T="string" @bind-Value="@_searchParams.SelectedGenre"
                           Label="Genre"
                           Variant="Variant.Outlined"
                           Clearable="true">
                    @foreach (var genre in _genres)
                    {
                        <MudSelectItem Value="@genre">@genre</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="2" Class="d-flex align-center">
                <MudCheckBox @bind-Value="@_searchParams.IncludeDlcs"
                             Label="Include DLCs"
                             Color="Color.Primary"/>
            </MudItem>
            <MudItem xs="12" sm="12" md="2" Class="d-flex align-end">
                <MudButton OnClick="@SearchGamesClick"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Search"
                           FullWidth="true"
                           Style="height: 56px;">
                    Search
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudDivider Class="my-4"/>

    @if (_isLoading)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" Class="mx-auto"/>
    }
    else
    {
        <MudGrid Spacing="3">
            @foreach (var game in _searchResults)
            {
                <MudItem xs="12" md="6">

                    <MudCard Outlined="true">
                        <MudGrid Spacing="0">
                            <MudItem xs="4">
                                <MudImage Src="@ImageUrl(game.ImageId)"
                                          Alt="@game.Name"
                                          ObjectFit="ObjectFit.Cover"
                                          Style="height: 100%; min-height: 180px;"/>
                            </MudItem>

                            <MudItem xs="8" Style="position: relative;">
                                <MudCardContent>
                                    <MudText Typo="Typo.h6">@game.Name</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Inherit">@FormatReleaseDate(game.FirstReleaseDate)</MudText>
                                    <MudText Typo="Typo.caption" Class="mt-2">@TruncateText(game.Summary, 250)</MudText>
                                </MudCardContent>

                                <MudOverlay Visible="false"
                                            OnHover="true"
                                            Absolute="true"
                                            Class="d-flex align-end justify-end pa-2">
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Secondary"
                                               Size="Size.Small"
                                               OnClick="() => AddToList(game)">
                                        Add to List
                                    </MudButton>
                                </MudOverlay>
                            </MudItem>
                        </MudGrid>
                    </MudCard>

                </MudItem>
            }
        </MudGrid>
    }
}


@code {
    [Inject] private ILogger<SearchGames> Logger { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;
    [Inject] private IYglGamesClient GamesClient { get; set; } = default!;
    [Inject] private IUserLoginStateManager UserLoginStateManager { get; set; } = default!;

    private bool _isUserLoggedIn = false;

    private bool _isLoadingGames = false;

    private bool _searchGamesButtonDisabled = false;
    private string _searchGamesButtonText = "Search!";

    public class SearchParameters
    {
        public string SearchText { get; set; } = "";
        public string? SelectedTheme { get; set; }
        public string? SelectedGenre { get; set; }
        public bool IncludeDlcs { get; set; }
    }

    // --- Component State ---
    private SearchParameters _searchParams { get; set; } = new SearchParameters();
    private bool _isLoading = false;
    private List<GameDto> _searchResults = new();
    private List<string> _themes = new();
    private List<string> _genres = new();

    // --- Lifecycle & Methods ---
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _isUserLoggedIn = await UserLoginStateManager.IsUserLoggedIn();

        // 1. Load data for dropdowns (mocked)
        _themes = new List<string>
        {
            "Sci-Fi",
            "Fantasy",
            "Modern"
        };

        _genres = new List<string>
        {
            "RPG",
            "Shooter",
            "Strategy"
        };
    }

    private async Task SearchGamesClick()
    {
        _isLoadingGames = true;
        _searchGamesButtonDisabled = true;
        _searchGamesButtonText = "Searching...";
        try
        {
            var token = await UserLoginStateManager.GetUserToken();

            if (string.IsNullOrWhiteSpace(token))
            {
                //TODO: better error handling
                return;
            }

            var res = await GamesClient.SearchGames(token, _searchParams.SearchText);
            if (res.IsFailure)
            {
                switch (res.Error)
                {
                    default:
                        Snackbar.Add("Failed to load games from server. Please try again.", Severity.Warning);
                        break;
                }

                return;
            }

            var games = res.Value;
            _searchResults = games.ToList();
        }
        finally
        {
            _isLoadingGames = false;
            _searchGamesButtonDisabled = false;
            _searchGamesButtonText = "Search!";
        }
    }

    private const string GameReleaseDateFormat = "yyyy MMMM dd";


    private static string FormatReleaseDate(long unixTimeSeconds)
    {
        return DateTimeOffset.FromUnixTimeSeconds(unixTimeSeconds).ToString(GameReleaseDateFormat);
    }

    private static string ImageUrl(string imageId)
    {
        return $"https://images.igdb.com/igdb/image/upload/t_cover_big/{imageId}.jpg";
    }

    private static string TruncateText(string text, int maxLength)
    {
        if (maxLength <= 10)
        {
            maxLength = 10;
        }

        return text.Length >= maxLength ? $"{text[0..(maxLength - 3)]}..." : text;
    }

    private void AddToList(GameDto game)
    {
        // This is where you would call a service to add the game to a user's list
        Snackbar.Add($"'{game.Name}' added to your list!", Severity.Success);
    }

}